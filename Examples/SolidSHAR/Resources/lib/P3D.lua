P3D = {}
P3D.BlankHeader = "P3D\255\012\000\000\000\000\000\000\000"
P3D.Identifiers = {
	Texture = "\x00\x90\x01\x00",
	Texture_Glyph_List = "\x01\x20\x02\x00",
	Image = "\x01\x90\x01\x00",
	Image_Data = "\x02\x90\x01\x00",
	Light_Group = "\x80\x23\x00\x00",
	Shader = "\x00\x10\x01\x00",
	Scenegraph = "\x00\x01\x12\x00",
	Camera = "\x00\x22\x00\x00",
	Mesh = "\x00\x00\x01\x00",
	Export_Info = "\x30\x70\x00\x00",
	Light = "\x00\x30\x01\x00",
	Game_Attr = "\x00\x20\x01\x00",
	Particle_System = "\x0C\x58\x01\x00",
	Particle_System_Factory = "\x00\x58\x01\x00",
	Frontend_Project = "\x00\x80\x01\x00",
	Sprite = "\x05\x90\x01\x00",
	Texture_Font = "\x00\x20\x02\x00",
	Expression_Group = "\x01\x10\x02\x00",
	Expression_Mixer = "\x02\x10\x02\x00",
	Animation = "\x00\x10\x12\x00",
	Skeleton = "\x00\x45\x00\x00",
	Skeleton_2 = "\x00\x30\x02\x00",
	Frame_Controller = "\x01\x12\x12\x00",
	Old_Frame_Controller = "\x00\x12\x12\x00",
	Multi_Controller = "\xA0\x48\x00\x00",
	Multi_Controller_2 = "\x02\x12\x12\x00",
	Composite_Drawable = "\x12\x45\x00\x00",
	Composite_Drawable_Skin_List = "\x13\x45\x00\x00",
	Composite_Drawable_Prop_List = "\x14\x45\x00\x00",
	Composite_Drawable_Effect_List = "\x17\x45\x00\x00",
	Composite_Drawable_2 = "\x00\x30\x12\x00",
	Skin = "\x01\x00\x01\x00",
	Locator_3 = "\x00\x40\x01\x00",
	Frontend_Text_Bible = "\x0D\x80\x01\x00",
	Frontend_Language = "\x0E\x80\x01\x00",
	Billboard_Quad_Group = "\x06\x70\x01\x00",
	Old_Billboard_Quad_Group = "\x02\x70\x01\x00",
	History = "\x00\x70\x00\x00",
	Mesh_Stats = "\x1D\x00\x01\x00",
	Physics_Object = "\x00\x10\x01\x07",
	Collision_Object = "\x00\x00\x01\x07",
	Collision_Volume_Owner = "\x21\x00\x01\x07",
	Collision_Volume_Owner_Name = "\x22\x00\x01\x07",
	Collision_Volume = "\x01\x00\x01\x07",
	Collision_Axis_Aligned_Bounding_Box = "\x06\x00\x01\x07",
	Collision_Oriented_Bounding_Box = "\x04\x00\x01\x07",
	Collision_Vector = "\x07\x00\x01\x07",
	Collision_Sphere = "\x02\x00\x01\x07",
	Collision_Wall = "\x05\x00\x01\x07",
	Collision_Object_Attribute = "\x23\x00\x01\x07",
	Old_Primitive_Group = "\x02\x00\x01\x00",
	Bounding_Box = "\x03\x00\x01\x00",
	Bounding_Sphere = "\x04\x00\x01\x00",
	Render_Status = "\x17\x00\x01\x00",
	Vertex_Shader = "\x11\x00\x01\x00",
	Position_List = "\x05\x00\x01\x00",
	Packed_Normal_List = "\x10\x00\x01\x00",
	Normal_List = "\x06\x00\x01\x00",
	UV_List = "\x07\x00\x01\x00",
	Index_List = "\x0A\x00\x01\x00",
	Matrix_List = "\x0B\x00\x01\x00",
	Weight_List = "\x0C\x00\x01\x00",
	Matrix_Palette = "\x0D\x00\x01\x00",
	Old_Scenegraph_Root = "\x01\x01\x12\x00",
	Old_Scenegraph_Branch = "\x02\x01\x12\x00",
	Old_Scenegraph_Transform = "\x03\x01\x12\x00",
	Old_Scenegraph_Drawable = "\x07\x01\x12\x00",
	Old_Scenegraph_Sort_Order = "\x0A\x01\x12\x00",
	Shader_Texture_Parameter = "\x02\x10\x01\x00",
	Shader_Integer_Parameter = "\x03\x10\x01\x00",
	Shader_Float_Parameter = "\x04\x10\x01\x00",
	Shader_Colour_Parameter = "\x05\x10\x01\x00",
	Skeleton_Joint = "\x01\x45\x00\x00",
	Skeleton_Joint_Mirror_Map = "\x03\x45\x00\x00",
	Skeleton_Joint_Bone_Preserve = "\x04\x45\x00\x00",
	Old_Billboard_Quad = "\x01\x70\x01\x00",
	Old_Billboard_Display_Info = "\x03\x70\x01\x00",
	Old_Billboard_Perspective_Info = "\x04\x70\x01\x00",
	Physics_Joint = "\x20\x10\x01\x07",
	Physics_Vector = "\x02\x10\x01\x07",
	Physics_Inertia_Matrix = "\x01\x10\x01\x07",
	Composite_Drawable_Prop = "\x16\x45\x00\x00",
	Composite_Drawable_Sort_Order = "\x19\x45\x00\x00",
	Export_Info_Named_String = "\x31\x70\x00\x00",
	Export_Info_Named_Integer = "\x32\x70\x00\x00",
	Primitive_Group = "\x20\x00\x01\x00",
	Colour_List = "\x08\x00\x01\x00",
	Game_Attribute_Integer_Parameter = "\x01\x20\x01\x00",
	Sort_Order = "\x00\x20\x12\x00",
	Animated_Object = "\x01\x00\x02\x00",
	State_Prop_Data_V1 = "\x00\x00\x02\x08",
	State_Prop_State_Data_V1 = "\x01\x00\x02\x08",
	State_Prop_Visibilities_Data = "\x02\x00\x02\x08",
	State_Prop_Frame_Controller_Data = "\x03\x00\x02\x08",
	Old_Particle_Instancing_Info = "\x0B\x58\x01\x00",
	Old_Sprite_Emitter = "\x06\x58\x01\x00",
	Old_Base_Emitter = "\x05\x58\x01\x00",
	Old_Particle_Animation = "\x08\x58\x01\x00",
	Old_Emitter_Animation = "\x09\x58\x01\x00",
	Old_Generator_Animation = "\x0A\x58\x01\x00",
	Animation_Size = "\x04\x10\x12\x00",
	Animation_Group_List = "\x02\x10\x12\x00",
	Animation_Group = "\x01\x10\x12\x00",
	Integer_Channel = "\x0E\x11\x12\x00",
	Float_1_Channel = "\x00\x11\x12\x00",
	Colour_Channel = "\x09\x11\x12\x00",
	Float_2_Channel = "\x01\x11\x12\x00",
	Boolean_Channel = "\x08\x11\x12\x00",
	Channel_Interpolation_Mode = "\x10\x11\x12\x00",
	Composite_Drawable_Effect = "\x18\x45\x00\x00",
	State_Prop_Event_Data = "\x04\x00\x02\x08",
	State_Prop_Callback_Data = "\x05\x00\x02\x08",
	Multi_Controller_Tracks = "\xA1\x48\x00\x00",
	Inst_Particle_System = "\x01\x10\x00\x03",
	Frontend_Page = "\x02\x80\x01\x00",
	Frontend_Layer = "\x03\x80\x01\x00",
	Frontend_Polygon = "\x09\x80\x01\x00",
	Frontend_Image_Resource = "\x00\x81\x01\x00",
	Frontend_Pure3D_Resource = "\x01\x81\x01\x00",
	Frontend_Screen = "\x01\x80\x01\x00",
	Frontend_Text_Bible_Resource = "\x05\x81\x01\x00",
	Frontend_Text_Style_Resource = "\x04\x81\x01\x00",
	Frontend_Pure3D_Object = "\x08\x80\x01\x00",
	Frontend_Group = "\x04\x80\x01\x00",
	Frontend_Multi_Text = "\x07\x80\x01\x00",
	Frontend_Multi_Sprite = "\x06\x80\x01\x00",
	Frontend_String_Text_Bible = "\x0B\x80\x01\x00",
	Frontend_String_Hard_Coded = "\x0C\x80\x01\x00",
	Composite_Drawable_Skin = "\x15\x45\x00\x00",
	Old_Vertex_Anim_Key_Frame = "\x04\x13\x12\x00",
	Old_Vector_Offset_List = "\x01\x13\x12\x00",
	Vector_2D_OF_Channel = "\x03\x11\x12\x00",
	Vector_3D_OF_Channel = "\x04\x11\x12\x00",
	Quaternion_Channel = "\x05\x11\x12\x00",
	Collision_Cylinder = "\x03\x00\x01\x07",
	Light_Position = "\x02\x30\x01\x00",
	Light_Direction = "\x01\x30\x01\x00",
	Light_Shadow = "\x04\x30\x01\x00",
	Entity_Channel = "\x07\x11\x12\x00",
	Set = "\x10\x01\x00\x03",
	Static_Entity = "\x00\x00\xF0\x03",
	Locator = "\x05\x00\x00\x03",
	Trigger_Volume = "\x06\x00\x00\x03",
	Locator_Matrix = "\x0C\x00\x00\x03",
	Intersect = "\x03\x00\xF0\x03",
	Fence = "\x07\x00\xF0\x03",
	Fence_2 = "\x00\x00\x00\x03",
	Breakable_Object = "\x00\x10\x00\x03",
	Anim = "\x0C\x00\xF0\x03",
	Static_Phys = "\x01\x00\xF0\x03",
	Anim_Dyna_Phys = "\x0E\x00\xF0\x03",
	Path = "\x0B\x00\x00\x03",
	Particle_System_2 = "\x01\x58\x01\x00",
	Anim_Coll = "\x08\x00\xF0\x03",
	Inst_Stat_Phys = "\x0A\x00\xF0\x03",
	Dyna_Phys = "\x02\x00\xF0\x03",
	Root = "\x50\x33\x44\xFF",
	World_Sphere = "\x0B\x00\xF0\x03",
	Follow_Camera_Data = "\x00\x01\x00\x03",
	Intersection = "\x04\x00\x00\x03",
	Road = "\x03\x00\x00\x03",
	Tree = "\x04\x00\xF0\x03",
	Instance_List = "\x08\x00\x00\x03",
	Collision_Effect = "\x00\x06\x00\x03",
	Vector_1D_OF_Channel = "\x02\x11\x12\x00",
	Compressed_Quaternion_Channel = "\x11\x11\x12\x00",
	Old_Scenegraph_Visibility = "\x04\x01\x12\x00",
	Old_Scenegraph_Light_Group = "\x09\x01\x12\x00",
	Old_Expression_Offsets = "\x18\x00\x01\x00",
	Old_Offset_List = "\x0E\x00\x01\x00",
	Expression = "\x00\x10\x02\x00",
	Anim_Obj_Wrapper = "\x10\x00\xF0\x03",
	Anim_Dyna_Phys_Wrapper = "\x0F\x00\xF0\x03",
	ATC = "\x02\x06\x00\x03",
	Primitive_Group_Memory_Image_Vertex_Description = "\x14\x00\x01\x00",
	Primitive_Group_Memory_Image_Vertex = "\x12\x00\x01\x00",
	Primitive_Group_Memory_Image_Index = "\x13\x00\x01\x00",
	Inst_Stat_Entity = "\x09\x00\xF0\x03",
	Composite_Drawable_Primitive = "\x01\x30\x12\x00",
	Vertex_Compression_Hint = "\x21\x00\x01\x00",
	Spline = "\x07\x00\x00\x03",
	Skeleton_Joint_2 = "\x01\x30\x02\x00",
	Skeleton_Partition = "\x02\x30\x02\x00",
	Skeleton_Limb = "\x03\x30\x02\x00",
	Scenegraph_Root = "\x0B\x01\x12\x00",
	Scenegraph_Branch = "\x0C\x01\x12\x00",
	Scenegraph_Transform = "\x0D\x01\x12\x00",
	Scenegraph_Drawable = "\x0F\x01\x12\x00",
	Sprite_Particle_Emitter = "\x00\x59\x01\x00",
	Particle_Point_Generator = "\x00\x5B\x01\x00",
	Animation_Header = "\x06\x10\x12\x00",
	Animation_Channel_Count = "\x07\x10\x12\x00",
	Animation_Sync_Frame = "\x02\x14\x12\x00",
	Locator_Counts = "\x23\x10\x00\x00",
	Black_Magic = "\x25\x10\x00\x00",
	Locator_2 = "\x03\x10\x00\x00",
	Trigger_Volume_2 = "\x04\x10\x00\x00",
	Road_2 = "\x05\x10\x00\x00",
	Intersect_Mesh = "\x08\x10\x00\x00",
	Intersect_Mesh_2 = "\x09\x10\x00\x00",
	Unknown_4520 = "\x20\x45\x00\x00",
	Unknown_1011 = "\x11\x10\x00\x00",
	Unknown_1010 = "\x10\x10\x00\x00",
	Grid = "\x00\x10\x00\x00",
	Grid_Cell = "\x01\x10\x00\x00",
	Unknown1021 = "\x21\x10\x00\x00",
	Unknown1022 = "\x22\x10\x00\x00",
	Unknown1024 = "\x24\x10\x00\x00",
	Unknown17000 = "\x00\x70\x01\x00",
	Tree_Node = "\x05\x00\xF0\x03",
	Tree_Node_2 = "\x06\x00\xF0\x03",
	Surface_Type_List = "\x0E\x00\x00\x03",
	Lens_Flare = "\x0D\x00\xF0\x03",
	Road_Data_Segment = "\x09\x00\x00\x03",
	Road_Segment = "\x02\x00\x00\x03",
	Animated_Object_Factory = "\x00\x00\x02\x00",
	Animated_Object_Animation = "\x02\x00\x02\x00",
	Unknown300000A = "\x0A\x00\x00\x03",
	Unknown121203 = "\x03\x12\x12\x00",
	Unknown13008 = "\x08\x30\x01\x00",
	Ph = "\x11\xC1\x00\x00",
	Ph_Vector = "\x10\xC0\x00\x00",
	Ph_Inertia_Matrix = "\x01\xC0\x00\x00",
	Ph_Volume = "\x02\xC0\x00\x00",
	Ph_Sphere = "\x03\xC0\x00\x00",
	Ph_Axis_Aligned_Bounding_Box = "\x07\xC0\x00\x00",
	Ph_Oriented_Bounding_Box = "\x05\xC0\x00\x00",
	Unknown4700 = "\x00\x47\x00\x00",
	Unknown4201 = "\x01\x42\x00\x00",
	Unknown4702 = "\x02\x47\x00\x00",
	Unknown4805 = "\x05\x48\x00\x00",
	Unknown4803 = "\x03\x48\x00\x00",
	Unknown4804 = "\x04\x48\x00\x00",
	Unknown4801 = "\x01\x48\x00\x00",
	Unknown4802 = "\x02\x48\x00\x00",
	Unknown1014 = "\x14\x10\x00\x00",
	Unknown1013 = "\x13\x10\x00\x00",
	Texture_2 = "\x00\x35\x00\x00",
	Image_2 = "\x10\x35\x00\x00",
	Image_Data_2 = "\x11\x35\x00\x00",
	Unknown4290 = "\x90\x42\x00\x00",
	Unknown4291 = "\x91\x42\x00\x00",
	Particle_System = "\x00\x50\x01\x00",
	Unknown15402 = "\x02\x54\x01\x00",
	Unknown15401 = "\x01\x54\x01\x00",
	Unknown15400 = "\x00\x54\x01\x00",
	Unknown15214 = "\x14\x52\x01\x00",
	Unknown15200 = "\x00\x52\x01\x00",
	Unknown15217 = "\x17\x52\x01\x00",
	Unknown15218 = "\x18\x52\x01\x00",
	Unknown4216 = "\x16\x42\x00\x00",
	Unknown15219 = "\x19\x52\x01\x00",
	Unknown1521A = "\x1A\x52\x01\x00",
	Unknown1521B = "\x1B\x52\x01\x00",
	Unknown1521C = "\x1C\x52\x01\x00",
	Unknown1521D = "\x1D\x52\x01\x00",
	Unknown15227 = "\x27\x52\x01\x00",
	Unknown15228 = "\x28\x52\x01\x00",
	Unknown15140 = "\x40\x51\x01\x00",
	Unknown15101 = "\x01\x51\x01\x00",
	Unknown15102 = "\x02\x51\x01\x00",
	Unknown15103 = "\x03\x51\x01\x00",
	Unknown15220 = "\x20\x52\x01\x00",
	Unknown15223 = "\x23\x52\x01\x00",
	Unknown15502 = "\x02\x55\x01\x00",
	Unknown15501 = "\x01\x55\x01\x00",
	Unknown15210 = "\x10\x52\x01\x00",
	Unknown15211 = "\x11\x52\x01\x00",
	Unknown15212 = "\x12\x52\x01\x00",
	Unknown15213 = "\x13\x52\x01\x00",
	Unknown15215 = "\x15\x52\x01\x00",
	Unknown15216 = "\x16\x52\x01\x00",
	Unknown15224 = "\x24\x52\x01\x00",
	Unknown15225 = "\x25\x52\x01\x00",
	Unknown15226 = "\x26\x52\x01\x00",
	Unknown15229 = "\x29\x52\x01\x00",
	Unknown1521E = "\x1E\x52\x01\x00",
	Unknown1521F = "\x1F\x52\x01\x00",
	Unknown15221 = "\x21\x52\x01\x00",
	Unknown15222 = "\x22\x52\x01\x00",
	Unknown15F00 = "\x00\x5F\x01\x00",
	Unknown4A01 = "\x01\x4A\x00\x00",
	Unknown4A82 = "\x82\x4A\x00\x00",
	Unknown4A20 = "\x20\x4A\x00\x00",
	Unknown4A10 = "\x10\x4A\x00\x00",
	Unknown4A11 = "\x11\x4A\x00\x00",
	Unknown9150 = "\x50\x91\x00\x00",
	Unknown4900 = "\x00\x49\x00\x00",
	Unknown4901 = "\x01\x49\x00\x00",
	Unknown4902 = "\x02\x49\x00\x00",
	Unknown4903 = "\x03\x49\x00\x00",
	Unknown4904 = "\x04\x49\x00\x00",
	Unknown4905 = "\x05\x49\x00\x00",
	Unknown4800 = "\x00\x48\x00\x00",
	Ph_Cylinder = "\x04\xC0\x00\x00",
	Texture_Animation = "\x20\x35\x00\x00",
	Unknown3521 = "\x21\x35\x00\x00",
	Unknown42A0 = "\xA0\x42\x00\x00",
	Unknown18102 = "\x02\x81\x01\x00",
	Unknown17007 = "\x07\x70\x01\x00",
	Unknown17005 = "\x05\x70\x01\x00",
	Unknown17009 = "\x09\x70\x01\x00",
	Unknown1700A = "\x0A\x70\x01\x00",
	Unknown1700D = "\x0D\x70\x01\x00",
	Unknown121204 = "\x04\x12\x12\x00",
	Unknown13003 = "\x03\x30\x01\x00"
}
local pack = string.pack
local unpack = string.unpack

function P3D.UnpackChunkHeader(str, StartPosition)
	if StartPosition == nil then StartPosition = 1 end
	
	return unpack("<c4II", str, StartPosition)
end

function P3D.String1ToInt(str, StartPosition)
	if StartPosition == nil then StartPosition = 1 end
	
	return unpack("<B", str, StartPosition)
end
P3D.IntToString1 = string.char
function P3D.SetInt1(Chunk, Offset, NewValue)
	return Chunk:sub(1, Offset - 1) .. P3D.IntToString1(NewValue) .. Chunk:sub(Offset + 1)
end

function P3D.String2ToInt(str, StartPosition)
	if StartPosition == nil then StartPosition = 1 end
	
	return unpack("<h", str, StartPosition)
end
function P3D.IntToString2(int)
	return pack("<h", int)
end
function P3D.SetIn2(Chunk, Offset, NewValue)
	return Chunk:sub(1, Offset - 1) .. P3D.IntToString2(NewValue) .. Chunk:sub(Offset + 4)
end

function P3D.String4ToInt(str, StartPosition)
	if StartPosition == nil then StartPosition = 1 end
	
	return unpack("<i", str, StartPosition)
end
function P3D.IntToString4(int)
	return pack("<i", int)
end
function P3D.SetInt4(Chunk, Offset, NewValue)
	return Chunk:sub(1, Offset - 1) .. P3D.IntToString4(NewValue) .. Chunk:sub(Offset + 4)
end

function P3D.String4ToFloat(str, StartPosition)
	if StartPosition == nil then StartPosition = 1 end
	
	return unpack("<f", str, StartPosition)
end
function P3D.FloatToString4(float)
	return pack("<f", float)
end
function P3D.SetFloat(Chunk, Offset, NewValue)
	return Chunk:sub(1, Offset - 1) .. P3D.FloatToString4(NewValue) .. Chunk:sub(Offset + 4)
end

function P3D.String4ToARGB(str, StartPosition)
	if StartPosition == nil then StartPosition = 1 end
	
	local B, G, R, A = unpack("<BBBB", str, StartPosition)
	return A, R, G, B
end
function P3D.ARGBToString4(A, R, G, B)
	return pack("<BBBB", B, G, R, A)
end
function P3D.SetARGB(Chunk, Offset, A, R, G, B)
	return Chunk:sub(1, Offset - 1) .. P3D.ARGBToString4(A, R, G, B) .. Chunk:sub(Offset + 4)
end

function P3D.String8ToVector2(str, StartPosition)
	if StartPosition == nil then StartPosition = 1 end
	
	return unpack("<ff", str, StartPosition)
end
function P3D.Vector2ToString8(X, Y)
	return pack("<ff", X, Y)
end
function P3D.SetVector2(Chunk, Offset, X, Y)
	return Chunk:sub(1, Offset - 1) .. P3D.Vector2ToString8(X, Y) .. Chunk:sub(Offset + 8)
end

function P3D.String12ToVector3(str, StartPosition)
	if StartPosition == nil then StartPosition = 1 end
	
	return unpack("<fff", str, StartPosition)
end
function P3D.Vector3ToString12(X, Y, Z)
	return pack("<fff", X, Y, Z)
end
function P3D.SetVector3(Chunk, Offset, X, Y, Z)
	return Chunk:sub(1, Offset - 1) .. P3D.Vector3ToString12(X, Y, Z) .. Chunk:sub(Offset + 12)
end

function P3D.String16ToVector4(str, StartPosition)
	if StartPosition == nil then StartPosition = 1 end
	
	return unpack("<ffff", str, StartPosition)
end
function P3D.Vector4ToString16(X, Y, Z, W)
	return pack("<ffff", X, Y, Z, W)
end
function P3D.SetVector4(Chunk, Offset, X, Y, Z, W)
	return Chunk:sub(1, Offset - 1) .. P3D.Vector4ToString16(X, Y, Z, W) .. Chunk:sub(Offset + 16)
end

function P3D.String64ToMatrix(str, StartPosition)
	if StartPosition == nil then StartPosition = 1 end
	
	return unpack("<ffffffffffffffff", str, StartPosition)
end
function P3D.MatrixToString64(M11, M12, M13, M14, M21, M22, M23, M24, M31, M32, M33, M34, M41, M42, M43, M44)
	return pack("<ffffffffffffffff", M11, M12, M13, M14, M21, M22, M23, M24, M31, M32, M33, M34, M41, M42, M43, M44)
end
function P3D.SetMatrix(Chunk, Offset, M11, M12, M13, M14, M21, M22, M23, M24, M31, M32, M33, M34, M41, M42, M43, M44)
	return Chunk:sub(1, Offset - 1) .. P3D.MatrixToString64(M11, M12, M13, M14, M21, M22, M23, M24, M31, M32, M33, M34, M41, M42, M43, M44) .. Chunk:sub(Offset + 64)
end
function P3D.MatrixIdentity()
	return {M11=1,M12=0,M13=0,M14=0,M21=0,M22=1,M23=0,M24=0,M31=0,M32=0,M33=1,M34=0,M41=0,M42=0,M43=0,M44=1}
end
function P3D.MatrixRotateY(Matrix, angle)
	angle = math.rad(angle)
	local cos = math.cos(angle)
	local sin = math.sin(angle)
	local x, y, z = Matrix.M41, Matrix.M42, Matrix.M43
	Matric = P3D.MatrixIdentity()
	Matrix.M11 = cos
	Matrix.M13 = sin * -1
	Matrix.M31 = sin
	Matrix.M33 = cos
	Matrix.M41 = x
	Matrix.M42 = y
	Matrix.M43 = z
end

function P3D.GetString(str, StartPosition)
	if StartPosition == nil then StartPosition = 1 end
	local output = unpack("<s1", str, StartPosition)
	return output, output:len()
end
function P3D.SetString(Chunk, Offset, NewString)
	local OrigName, OrigLen = P3D.GetString(Chunk, Offset)
	local New = Chunk:sub(1, Offset - 1) .. pack("<s1", NewString) .. Chunk:sub(Offset + OrigLen + 1)
	local Delta = NewString:len() - OrigLen
	return New, Delta, OrigName
end

function P3D.GetFourCC(str, StartPosition)
	if StartPosition == nil then StartPosition = 1 end
	
	return unpack(str, "<c4", StartPosition)
end
function P3D.SetFourCC(Chunk, Offset, NewValue)
	return Chunk:sub(1, Offset - 1) .. pack("<c4", NewValue) .. Chunk:sub(Offset + 4)
end

function P3D.RemoveString(str, Start, End)
	return str:sub(1, Start - 1) .. str:sub(End)
end

function P3D.MakeP3DString(str)
	local strLen = str:len()
	local diff = strLen % 4
	if diff > 0 then
		str = str .. string.rep("\0", 4 - diff)
	end
	return str
end

function P3D.CleanP3DString(str)
	local strLen = str:len()
	if strLen == 0 then return str end
	local l = 0
	for i=strLen,1,-1 do
		if str:byte(i) ~= 0 then
			l = i
			break
		end
	end
	return str:sub(1, l)
end

function P3D.FindSubchunks(Chunk, ID, StartPosition, EndPosition)
	if StartPosition == nil then StartPosition = 1 end
	if EndPosition == nil then EndPosition = Chunk:len() end
	
	local Position = StartPosition + P3D.String4ToInt(Chunk, StartPosition + 4)
	return function()
		while Position < EndPosition do
			local ChunkID, ChunkValueLength, ChunkLength = P3D.UnpackChunkHeader(Chunk, Position)
			Position = Position + ChunkLength
			if ID == nil or ChunkID == ID then
				return Position - ChunkLength, ChunkLength, ChunkID
			end
		end
		return nil
	end
end
function P3D.FindSubchunk(Chunk, ID, StartPosition, EndPosition)
	return P3D.FindSubchunks(Chunk, ID, StartPosition, EndPosition)()
end

-- Class data start
P3D.P3DChunk = {Raw, ChunkTypes = {}, Chunks = {}}

function P3D.P3DChunk:__tostring()
	return self:Output()
end

function P3D.P3DChunk:new(Data)
	if Data == nil then
		Data = {}
		setmetatable(Data, self)
		self.__index = self
		return Data
	end
	Data.ChunkTypes = {}
	Data.Chunks = {}
	local ValueLen
	Data.ChunkType, ValueLen = P3D.UnpackChunkHeader(Data.Raw)
	if ValueLen > 12 then
		Data.ValueStr = Data.Raw:sub(13, ValueLen)
	else
		Data.ValueStr = ""
	end
	local i
	for ChunkPos, ChunkLen, ChunkID in P3D.FindSubchunks(Data.Raw, nil) do
		i = #Data.ChunkTypes + 1
		Data.ChunkTypes[i] = Data.Raw:sub(ChunkPos, ChunkPos + 3)
		Data.Chunks[i] = Data.Raw:sub(ChunkPos, ChunkPos + ChunkLen - 1)
	end
	self.__index = self
	return setmetatable(Data, self)
end

function P3D.P3DChunk:newChildClass(type)
	self.__index = self
	return setmetatable({type = type or "none", parentClass = self}, self)
end

function P3D.P3DChunk:GetChunkCount()
	return #self.ChunkTypes
end

function P3D.P3DChunk:RemoveChunkAtIndex(idx)
	local ChunkLen = self.Chunks[idx]:len()
	table.remove(self.ChunkTypes, idx)
	table.remove(self.Chunks, idx)
end

function P3D.P3DChunk:GetChunkAtIndex(idx)
	return self.Chunks[idx]
end

function P3D.P3DChunk:SetChunkAtIndex(idx, ChunkData)
	if #self.ChunkTypes < idx then return end
	local ChunkLen = ChunkData:len()
	if ChunkLen < 13 then return end
	local OldLen = self.Chunks[idx]:len()
	self.ChunkTypes[idx] = ChunkData:sub(1, 4)
	self.Chunks[idx] = ChunkData
end

function P3D.P3DChunk:AddChunk(ChunkData)
	local ChunkLen = ChunkData:len()
	if ChunkLen < 12 then return end
	local ChunkID = ChunkData:sub(1, 4)
	self.ChunkTypes[#self.ChunkTypes + 1] = ChunkID
	self.Chunks[#self.Chunks + 1] = ChunkData
end

function P3D.P3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local len = 12 + self.ValueStr:len()
	return pack("<c4II", self.ChunkType, len, len + chunks:len()) .. self.ValueStr .. chunks
end

function P3D.P3DChunk:GetName()
	local name = self.Name or P3D.GetString(self.ValueStr)
	self.Name = name
	return name
end

function P3D.P3DChunk:SetName(NewName)
	if self.ValueStr:len() < 2 then return end
	NewName = MakeP3DString(NewName)
	self.ValueStr = P3D.SetString(self.ValueStr, 1, NewName)
	self.Name = NewName
end

function P3D.P3DChunk:GetChunkIndexes(ChunkID)
	local i = #self.ChunkTypes
	return function()
		while i > 0 do
			local ChunkType = self.ChunkTypes[i]
			i = i - 1
			if ChunkID == nil or ChunkType == ChunkID then
				return i + 1, ChunkType
			end
		end
		return nil
	end
end

function P3D.P3DChunk:GetChunkIndex(ChunkID)
	return self:GetChunkIndexes(ChunkID)()
end

--Texture Chunk
P3D.TextureP3DChunk = P3D.P3DChunk:newChildClass("Texture")
function P3D.TextureP3DChunk:new(Data)
	local o = P3D.TextureP3DChunk.parentClass.new(self, Data)
	o.Name, o.Version, o.Width, o.Height, o.Bpp, o.AlphaDepth, o.NumMipMaps, o.TextureType, o.Usage, o.Priority = unpack("<s1iiiiiiiii", o.ValueStr)
	return o
end

function P3D.TextureP3DChunk:create(Name,Version,Width,Height,Bpp,AlphaDepth,NumMipMaps,TextureType,Usage,Priority)
	local Len = 12 + Name:len() + 1 + 4 + 4 + 4 + 4 + 4 + 4 + 4 + 4 + 4
	return P3D.TextureP3DChunk:new{Raw = pack("<c4IIs1iiiiiiiii", P3D.Identifiers.Texture, Len, Len, Name, Version, Width, Height, Bpp, AlphaDepth, NumMipMaps, TextureType, Usage, Priority)}
end

function P3D.TextureP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4 + 4 + 4 + 4 + 4 + 4 + 4 + 4 + 4
	return pack("<c4IIs1iiiiiiiii", self.ChunkType, Len, Len + chunks:len(), self.Name, self.Version, self.Width, self.Height, self.Bpp, self.AlphaDepth, self.NumMipMaps, self.TextureType, self.Usage, self.Priority) .. chunks
end

--Image Chunk
P3D.ImageP3DChunk = P3D.P3DChunk:newChildClass("Image")
function P3D.ImageP3DChunk:new(Data)
	local o = P3D.ImageP3DChunk.parentClass.new(self, Data)
	o.Name, o.Version, o.Width, o.Height, o.Bpp, o.Palettized, o.HasAlpha, o.Format = unpack("<s1iiiiiii", o.ValueStr)
	return o
end

function P3D.ImageP3DChunk:create(Name,Version,Width,Height,Bpp,Palettized,HasAlpha,Format)
	local Len = 12 + Name:len() + 1 + 4 + 4 + 4 + 4 + 4 + 4 + 4
	return P3D.ImageP3DChunk:new{Raw = pack("<c4IIs1iiiiiii", P3D.Identifiers.Image, Len, Len, Name, Version, Width, Height, Bpp, Palettized, HasAlpha, Format)}
end

function P3D.ImageP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4 + 4 + 4 + 4 + 4 + 4 + 4
	return pack("<c4IIs1iiiiiii", self.ChunkType, Len, Len + chunks:len(), self.Name, self.Version, self.Width, self.Height, self.Bpp, self.Palettized, self.HasAlpha, self.Format) .. chunks
end

--Shader Chunk
P3D.ShaderP3DChunk = P3D.P3DChunk:newChildClass("Shader")
function P3D.ShaderP3DChunk:new(Data)
	local o = P3D.ShaderP3DChunk.parentClass.new(self, Data)
	o.Name, o.Version, o.PDDIShader, o.HasTranslucency, o.VertexNeeds, o.VertexMask, o.NumParams = unpack("<s1is1iiii", o.ValueStr)
	return o
end

function P3D.ShaderP3DChunk:create(Name,Version,PDDIShader,HasTranslucency,VertexNeeds,VertexMask,NumParams)
	local Len = 12 + Name:len() + 1 + 4 + PDDIShader:len() + 1 + 4 + 4 + 4 + 4
	return P3D.ShaderP3DChunk:new{Raw = pack("<c4IIs1is1iiii", P3D.Identifiers.Shader, Len, Len, Name, Version, PDDIShader, HasTranslucency, VertexNeeds, VertexMask, NumParams)}
end

function P3D.ShaderP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4 + self.PDDIShader:len() + 1 + 4 + 4 + 4 + 4
	return pack("<c4IIs1is1iiii", self.ChunkType, Len, Len + chunks:len(), self.Name, self.Version, self.PDDIShader, self.HasTranslucency, self.VertexNeeds, self.VertexMask, self.NumParams) .. chunks
end

function P3D.ShaderP3DChunk:SetIntParameter(Name, Value)
	if Name:len() > 4 then return end
	Name = P3D.MakeP3DString(Name)
	for idx in self:GetChunkIndexes(INTEGER_PARAMETER_CHUNK) do
		local ChunkData = self:GetChunkAtIndex(idx)
		if ChunkData:sub(13, 16) == Name then
			ChunkData = SetP3DInt4(ChunkData, 17, Value)
			self:SetChunkAtIndex(idx, ChunkData)
			return
		end
	end
end

function P3D.ShaderP3DChunk:GetIntParameter(Name)
	if Name:len() > 4 then return end
	Name = P3D.MakeP3DString(Name)
	for idx in self:GetChunkIndexes(INTEGER_PARAMETER_CHUNK) do
		local ChunkData = self:GetChunkAtIndex(idx)
		if ChunkData:sub(13, 16) == Name then
			return GetP3DInt4(ChunkData, 17)
		end
	end
	return nil
end

function P3D.ShaderP3DChunk:SetTextureParameter(Name, Value)
	if Name:len() > 4 then return end
	Name = P3D.MakeP3DString(Name)
	Value = P3D.MakeP3DString(Value)
	for idx in self:GetChunkIndexes(TEXTURE_PARAMETER_CHUNK) do
		local ChunkData = self:GetChunkAtIndex(idx)
		if ChunkData:sub(13, 16) == Name then
			local newVal, Delta = P3D.SetString(ChunkData, 17, Value)
			newVal = AddP3DInt4(newVal, 5, Delta)
			newVal = AddP3DInt4(newVal, 9, Delta)
			self:SetChunkAtIndex(idx, newVal)
			return
		end
	end
end

function P3D.ShaderP3DChunk:GetTextureParameter(Name)
	if Name:len() > 4 then return end
	Name = P3D.MakeP3DString(Name)
	for idx in self:GetChunkIndexes(TEXTURE_PARAMETER_CHUNK) do
		local ChunkData = self:GetChunkAtIndex(idx)
		if ChunkData:sub(13, 16) == Name then
			return P3D.GetString(ChunkData, 17)
		end
	end
	return nil
end

function P3D.ShaderP3DChunk:SetColourParameter(Name, A, R, G, B)
	if Name:len() > 4 then return end
	Name = P3D.MakeP3DString(Name)
	for idx in self:GetChunkIndexes(COLOUR_PARAMETER_CHUNK) do
		local ChunkData = self:GetChunkAtIndex(idx)
		if ChunkData:sub(13, 16) == Name then
			ChunkData = ChunkData:sub(1, 16) .. ARGBToString4(A, R, G, B)
			self:SetChunkAtIndex(idx, ChunkData)
			return
		end
	end
end

function P3D.ShaderP3DChunk:GetColourParameter(Name)
	if Name:len() > 4 then return end
	Name = P3D.MakeP3DString(Name)
	for idx in self:GetChunkIndexes(COLOUR_PARAMETER_CHUNK) do
		local ChunkData = self:GetChunkAtIndex(idx)
		if ChunkData:sub(13, 16) == Name then
			return GetP3DARGB(ChunkData, 17)
		end
	end
	return nil
end

function P3D.ShaderP3DChunk:SetFloatParameter(Name, Value)
	if Name:len() > 4 then return end
	Name = P3D.MakeP3DString(Name)
	for idx in self:GetChunkIndexes(FLOAT_PARAMETER_CHUNK) do
		local ChunkData = self:GetChunkAtIndex(idx)
		if ChunkData:sub(13, 16) == Name then
			ChunkData = SetP3DFloat(ChunkData, 17, Value)
			self:SetChunkAtIndex(idx, ChunkData)
			return
		end
	end
end

function P3D.ShaderP3DChunk:GetFloatParameter(Name)
	if Name:len() > 4 then return end
	Name = P3D.MakeP3DString(Name)
	for idx in self:GetChunkIndexes(FLOAT_PARAMETER_CHUNK) do
		local ChunkData = self:GetChunkAtIndex(idx)
		if ChunkData:sub(13, 16) == Name then
			return GetP3DFloat(ChunkData, 17)
		end
	end
	return nil
end

--Static Phys Chunk
P3D.StaticPhysP3DChunk = P3D.P3DChunk:newChildClass("Static Phys")
function P3D.StaticPhysP3DChunk:new(Data)
	local o = P3D.StaticPhysP3DChunk.parentClass.new(self, Data)
	o.Name, o.Unknown = unpack("<s1i", o.ValueStr)
	return o
end

function P3D.StaticPhysP3DChunk:create(Name,Unknown)
	local Len = 12 + Name:len() + 1 + 4
	return P3D.StaticPhysP3DChunk:new{Raw = pack("<c4IIs1i", P3D.Identifiers.Static_Phys, Len, Len, Name, Unknown)}
end

function P3D.StaticPhysP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4
	return pack("<c4IIs1i", self.ChunkType, Len, Len + chunks:len(), self.Name, self.Unknown) .. chunks
end

--Static Entity Chunk
P3D.StaticEntityP3DChunk = P3D.P3DChunk:newChildClass("Static Entity")
function P3D.StaticEntityP3DChunk:new(Data)
	local o = P3D.StaticEntityP3DChunk.parentClass.new(self, Data)
	o.Name, o.Unknown, o.RenderOrder = unpack("<s1ii", o.ValueStr)
	return o
end

function P3D.StaticEntityP3DChunk:create(Name,Unknown,RenderOrder)
	local Len = 12 + Name:len() + 1 + 4 + 4
	return P3D.StaticEntityP3DChunk:new{Raw = pack("<c4IIs1ii", P3D.Identifiers.Static_Entity, Len, Len, Name, Unknown, RenderOrder)}
end

function P3D.StaticEntityP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4 + 4
	return pack("<c4IIs1ii", self.ChunkType, Len, Len + chunks:len(), self.Name, self.Unknown, self.RenderOrder) .. chunks
end

--Inst Stat Phys Chunk
P3D.InstStatPhysP3DChunk = P3D.P3DChunk:newChildClass("Inst Stat Phys")
function P3D.InstStatPhysP3DChunk:new(Data)
	local o = P3D.InstStatPhysP3DChunk.parentClass.new(self, Data)
	o.Name, o.Unknown, o.RenderOrder = unpack("<s1ii", o.ValueStr)
	return o
end

function P3D.InstStatPhysP3DChunk:create(Name,Unknown,RenderOrder)
	local Len = 12 + Name:len() + 1 + 4 + 4
	return P3D.InstStatPhysP3DChunk:new{Raw = pack("<c4IIs1ii", P3D.Identifiers.Inst_Stat_Phys, Len, Len, Name, Unknown, RenderOrder)}
end

function P3D.InstStatPhysP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4 + 4
	return pack("<c4IIs1ii", self.ChunkType, Len, Len + chunks:len(), self.Name, self.Unknown, self.RenderOrder) .. chunks
end

--Inst Stat Entity Chunk
P3D.InstStatEntityP3DChunk = P3D.P3DChunk:newChildClass("Inst Stat Entity")
function P3D.InstStatEntityP3DChunk:new(Data)
	local o = P3D.InstStatEntityP3DChunk.parentClass.new(self, Data)
	o.Name, o.Unknown, o.RenderOrder = unpack("<s1ii", o.ValueStr)
	return o
end

function P3D.InstStatEntityP3DChunk:create(Name,Unknown,RenderOrder)
	local Len = 12 + Name:len() + 1 + 4 + 4
	return P3D.InstStatEntityP3DChunk:new{Raw = pack("<c4IIs1ii", P3D.Identifiers.Inst_Stat_Entity, Len, Len, Name, Unknown, RenderOrder)}
end

function P3D.InstStatEntityP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + Name:len() + 1 + 4 + 4
	return pack("<c4IIs1ii", self.ChunkType, Len, Len + chunks:len(), self.Name, self.Unknown, self.RenderOrder) .. chunks
end

--Dyna Phys Chunk
P3D.DynaPhysP3DChunk = P3D.P3DChunk:newChildClass("Dyna Phys")
function P3D.DynaPhysP3DChunk:new(Data)
	local o = P3D.DynaPhysP3DChunk.parentClass.new(self, Data)
	o.Name, o.Unknown, o.RenderOrder = unpack("<s1ii", o.ValueStr)
	return o
end

function P3D.DynaPhysP3DChunk:create(Name,Unknown,RenderOrder)
	local Len = 12 + Name:len() + 1 + 4 + 4
	return P3D.DynaPhysP3DChunk:new{Raw = pack("<c4IIs1ii", P3D.Identifiers.Dyna_Phys, Len, Len, Name, Unknown, RenderOrder)}
end

function P3D.DynaPhysP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4 + 4
	return pack("<c4IIs1ii", self.ChunkType, Len, Len + chunks:len(), self.Name, self.Unknown, self.RenderOrder) .. chunks
end

--Anim Chunk
P3D.AnimP3DChunk = P3D.P3DChunk:newChildClass("Anim")
function P3D.AnimP3DChunk:new(Data)
	local o = P3D.AnimP3DChunk.parentClass.new(self, Data)
	o.Name, o.Unknown, o.RenderOrder = unpack("<s1ii", o.ValueStr)
	return o
end

function P3D.AnimP3DChunk:create(Name,Unknown,RenderOrder)
	local Len = 12 + Name:len() + 1 + 4 + 4
	return P3D.AnimP3DChunk:new{Raw = pack("<c4IIs1ii", P3D.Identifiers.Anim, Len, Len, Name, Unknown, RenderOrder)}
end

function P3D.AnimP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4 + 4
	return pack("<c4IIs1ii", self.ChunkType, Len, Len + chunks:len(), self.Name, self.Unknown, self.RenderOrder) .. chunks
end

--Anim Coll Chunk
P3D.AnimCollP3DChunk = P3D.P3DChunk:newChildClass("Anim Coll")
function P3D.AnimCollP3DChunk:new(Data)
	local o = P3D.AnimCollP3DChunk.parentClass.new(self, Data)
	o.Name, o.Unknown, o.RenderOrder = unpack("<s1ii", o.ValueStr)
	return o
end

function P3D.AnimCollP3DChunk:create(Name,Unknown,RenderOrder)
	local Len = 12 + Name:len() + 1 + 4 + 4
	return P3D.AnimCollP3DChunk:new{Raw = pack("<c4IIs1ii", P3D.Identifiers.Anim_Coll, Len, Len, Name, Unknown, RenderOrder)}
end

function P3D.AnimCollP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4 + 4
	return pack("<c4IIs1ii", self.ChunkType, Len, Len + chunks:len(), self.Name, self.Unknown, self.RenderOrder) .. chunks
end

--Anim Dyna Phys Chunk
P3D.AnimDynaPhysP3DChunk = P3D.P3DChunk:newChildClass("Anim Dyna Phys")
function P3D.AnimDynaPhysP3DChunk:new(Data)
	local o = P3D.AnimDynaPhysP3DChunk.parentClass.new(self, Data)
	o.Name, o.Unknown, o.RenderOrder = unpack("<s1ii", o.ValueStr)
	return o
end

function P3D.AnimDynaPhysP3DChunk:create(Name,Unknown,RenderOrder)
	local Len = 12 + Name:len() + 1 + 4 + 4
	return P3D.AnimDynaPhysP3DChunk:new{Raw = pack("<c4IIs1ii", P3D.Identifiers.Anim_Dyna_Phys, Len, Len, Name, Unknown, RenderOrder)}
end

function P3D.AnimDynaPhysP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4 + 4
	return pack("<c4IIs1ii", self.ChunkType, Len, Len + chunks:len(), self.Name, self.Unknown, self.RenderOrder) .. chunks
end

--Anim Obj Wrapper Chunk
P3D.AnimObjWrapperP3DChunk = P3D.P3DChunk:newChildClass("Anim Obj Wrapper")
function P3D.AnimObjWrapperP3DChunk:new(Data)
	local o = P3D.AnimObjWrapperP3DChunk.parentClass.new(self, Data)
	o.Name, o.Unknown, o.Unknown2 = unpack("<s1BB", o.ValueStr)
	return o
end

function P3D.AnimObjWrapperP3DChunk:create(Name,Unknown,Unknown2)
	local Len = 12 + Name:len() + 1 + 1 + 1
	return P3D.AnimObjWrapperP3DChunk:new{Raw = pack("<c4IIs1BB", P3D.Identifiers.Anim_Obj_Wrapper, Len, Len, Name, Unknown, Unknown2)}
end

function P3D.AnimObjWrapperP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 1 + 1
	return pack("<c4IIs1BB", self.ChunkType, Len, Len + chunks:len(), self.Name, self.Unknown, self.Unknown2) .. chunks
end

--Breakable Object Chunk
P3D.BreakableObjectP3DChunk = P3D.P3DChunk:newChildClass("Breakable Object")
function P3D.BreakableObjectP3DChunk:new(Data)
	local o = P3D.BreakableObjectP3DChunk.parentClass.new(self, Data)
	o.Index, o.Count = unpack("<ii", o.ValueStr)
	return o
end

function P3D.BreakableObjectP3DChunk:create(Index,Count)
	local Len = 12 + 4 + 4
	return P3D.BreakableObjectP3DChunk:new{Raw = pack("<c4IIii", P3D.Identifiers.Breakable_Object, Len, Len, Index, Count)}
end

function P3D.BreakableObjectP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + 4 + 4
	return pack("<c4IIii", self.ChunkType, Len, Len + chunks:len(), self.Index, self.Count) .. chunks
end

--World Sphere Chunk
P3D.WorldSphereP3DChunk = P3D.P3DChunk:newChildClass("World Sphere")
function P3D.WorldSphereP3DChunk:new(Data)
	local o = P3D.WorldSphereP3DChunk.parentClass.new(self, Data)
	o.Name, o.Unknown, o.NumMeshes, o.NumBillboardQuadGroups = unpack("<s1iii", o.ValueStr)
	return o
end

function P3D.WorldSphereP3DChunk:create(Name,Unknown,NumMeshes,NumBillboardQuadGroups)
	local Len = 12 + Name:len() + 1 + 4 + 4 + 4
	return P3D.WorldSphereP3DChunk:new{Raw = pack("<c4IIs1iii", P3D.Identifiers.World_Sphere, Len, Len, Name, Unknown, NumMeshes, NumBillboardQuadGroups)}
end

function P3D.WorldSphereP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4 + 4 + 4
	return pack("<c4IIs1iii", self.ChunkType, Len, Len + chunks:len(), self.Name, self.Unknown, self.NumMeshes, self.NumBillboardQuadGroups) .. chunks
end

function P3D.WorldSphereP3DChunk:RemoveChunkAtIndex(idx)
	local ID = self.ChunkTypes[idx]
	P3D.WorldSphereP3DChunk.parentClass.RemoveChunkAtIndex(self, idx)
	if ID == P3D.Identifiers.Old_Billboard_Quad_Group then
		self.NumBillboardQuadGroups = self.NumBillboardQuadGroups - 1
	end
end

--Mesh Chunk
P3D.MeshP3DChunk = P3D.P3DChunk:newChildClass("Mesh")
function P3D.MeshP3DChunk:new(Data)
	local o = P3D.MeshP3DChunk.parentClass.new(self, Data)
	o.Name, o.Version, o.NumPrimitiveGroups = unpack("<s1ii", o.ValueStr)
	return o
end

function P3D.MeshP3DChunk:create(Name,Version,NumPrimitiveGroups)
	local Len = 12 + Name:len() + 1 + 4 + 4
	return P3D.MeshP3DChunk:new{Raw = pack("<c4IIs1ii", P3D.Identifiers.Mesh, Len, Len, Name, Version, NumPrimitiveGroups)}
end

function P3D.MeshP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4 + 4
	return pack("<c4IIs1ii", self.ChunkType, Len, Len + chunks:len(), self.Name, self.Version, self.NumPrimitiveGroups) .. chunks
end

function P3D.MeshP3DChunk:RemoveChunkAtIndex(idx)
	local ID = self.ChunkTypes[idx]
	P3D.MeshP3DChunk.parentClass.RemoveChunkAtIndex(self, idx)
	if ID == P3D.Identifiers.Old_Primitive_Group then
		self.NumPrimitiveGroups = self.NumPrimitiveGroups - 1
	end
end

--Old Primitive Group Chunk
P3D.OldPrimitiveGroupP3DChunk = P3D.P3DChunk:newChildClass("Old Primitive Group")
function P3D.OldPrimitiveGroupP3DChunk:new(Data)
	local o = P3D.OldPrimitiveGroupP3DChunk.parentClass.new(self, Data)
	o.Version, o.ShaderName, o.PrimitiveType, o.VertexType, o.NumVertices, o.NumIndices, o.NumMatrices = unpack("<is1iiiii", o.ValueStr)
	return o
end

function P3D.OldPrimitiveGroupP3DChunk:create(Version,ShaderName,PrimitiveType,VertexType,NumVertices,NumIndices,NumMatrices)
	local Len = 12 + 4 + ShaderName:len() + 1 + 4 + 4 + 4 + 4 + 4
	return P3D.OldPrimitiveGroupP3DChunk:new{Raw = pack("<c4IIis1iiiii", P3D.Identifiers.Old_Primitive_Group, Len, Len, Version, ShaderName, PrimitiveType, VertexType, NumVertices, NumIndices, NumMatrices)}
end

function P3D.OldPrimitiveGroupP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + 4 + self.ShaderName:len() + 1 + 4 + 4 + 4 + 4 + 4
	return pack("<c4IIis1iiiii", self.ChunkType, Len, Len + chunks:len(), self.Version, self.ShaderName, self.PrimitiveType, self.VertexType, self.NumVertices, self.NumIndices, self.NumMatrices) .. chunks
end

--Colour List chunk
P3D.ColourListP3DChunk = P3D.P3DChunk:newChildClass("Colour List")
function P3D.ColourListP3DChunk:new(Data)
	local o = P3D.ColourListP3DChunk.parentClass.new(self, Data)
	local NumColours = unpack("<i", o.ValueStr)
	o.Colours = {}
	local idx = 5
	for i=0,NumColours - 1 do
		local col = {A=0,R=0,G=0,B=0}
		col.A, col.R, col.G, col.B = P3D.String4ToARGB(o.ValueStr, idx + i * 4)
		o.Colours[#o.Colours + 1] = col
	end
	return o
end

function P3D.ColourListP3DChunk:create(...)
	local ColoursN = #arg
	local len = 16 + ColoursN * 4
	local colours = {}
	for i=1,ColoursN do
		local col = arg[i]
		colours[#colours + 1] = ARGBToString4(col.A, col.R, col.G, col.B)
	end
	return P3D.MeshP3DChunk:new{Raw = pack("<c4IIi", P3D.Identifiers.Colour_List, len, len, ColoursN) .. table.concat(colours)}
end

function P3D.ColourListP3DChunk:Output()
	local ColoursN = #self.Colours
	local len = 16 + ColoursN * 4
	local colours = {}
	for i=1,ColoursN do
		local col = self.Colours[i]
		colours[#colours + 1] = P3D.ARGBToString4(col.A, col.R, col.G, col.B)
	end
	return pack("<c4IIi", self.ChunkType, len, len, ColoursN) .. table.concat(colours)
end

--Position List chunk
P3D.PositionListP3DChunk = P3D.P3DChunk:newChildClass("Position List")
function P3D.PositionListP3DChunk:new(Data)
	local o = P3D.PositionListP3DChunk.parentClass.new(self, Data)
	local NumPositions = unpack("<i", o.ValueStr)
	o.Positions = {}
	local idx = 5
	for i=0,NumPositions - 1 do
		local pos = {X=0,Y=0,Z=0}
		pos.X, pos.Y, pos.Z = P3D.String12ToVector3(o.ValueStr, idx + i * 12)
		o.Positions[#o.Positions + 1] = pos
	end
	return o
end

function P3D.PositionListP3DChunk:create(...)
	local PositionsN = #arg
	local len = 16 + PositionsN * 12
	local positions = {}
	for i=1,PositionsN do
		local pos = arg[i]
		positions[#positions + 1] = P3D.Vector3ToString12(pos,X, pos.Y, pos.Z)
	end
	return P3D.MeshP3DChunk:new{Raw = pack("<c4IIi", P3D.Identifiers.Colour_List, len, len, PositionsN) .. table.concat(positions)}
end

function P3D.PositionListP3DChunk:Output()
	local PositionsN = #self.Positions
	local len = 16 + PositionsN * 12
	local positions = {}
	for i=1,PositionsN do
		local pos = self.Positions[i]
		positions[#positions + 1] = P3D.Vector3ToString12(pos,X, pos.Y, pos.Z)
	end
	return pack("<c4IIi", self.ChunkType, len, len, PositionsN) .. table.concat(positions)
end

--Lens Flare Chunk
P3D.LensFlareP3DChunk = P3D.P3DChunk:newChildClass("Lens Flare")
function P3D.LensFlareP3DChunk:new(Data)
	local o = P3D.LensFlareP3DChunk.parentClass.new(self, Data)
	o.Name, o.Unknown, o.NumBillboardQuadGroups = unpack("<s1ii", o.ValueStr)
	return o
end

function P3D.LensFlareP3DChunk:create(Name,Unknown,NumBillboardQuadGroups)
	local Len = 12 + Name:len() + 1 + 4 + 4
	return P3D.LensFlareP3DChunk:new{Raw = pack("<c4IIs1ii", P3D.Identifiers.Lens_Flare, Len, Len, Name, Unknown, NumBillboardQuadGroups)}
end

function P3D.LensFlareP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4 + 4
	return pack("<c4IIs1ii", self.ChunkType, Len, Len + chunks:len(), self.Name, self.Unknown, self.NumBillboardQuadGroups) .. chunks
end

function P3D.LensFlareP3DChunk:RemoveChunkAtIndex(idx)
	local ID = self.ChunkTypes[idx]
	P3D.LensFlareP3DChunk.parentClass.RemoveChunkAtIndex(self, idx)
	if ID == P3D.Identifiers.Old_Billboard_Quad_Group then
		self.NumBillboardQuadGroups = self.NumBillboardQuadGroups - 1
	end
end

--Old Billboard Quad Group Chunk
P3D.OldBillboardQuadGroupP3DChunk = P3D.P3DChunk:newChildClass("Old Billboard Quad Group")
function P3D.OldBillboardQuadGroupP3DChunk:new(Data)
	local o = P3D.OldBillboardQuadGroupP3DChunk.parentClass.new(self, Data)
	o.Version, o.Name, o.Shader, o.ZTest, o.ZWrite, o.Fog, o.NumQuads = unpack("<is1s1iiii", o.ValueStr)
	return o
end

function P3D.OldBillboardQuadGroupP3DChunk:create(Version,Name,Shader,ZTest,ZWrite,Fog,NumQuads)
	local Len = 12 + 4 + Name:len() + 1 + Shader:len() + 1 + 4 + 4 + 4 + 4
	return P3D.OldBillboardQuadGroupP3DChunk:new{Raw = pack("<c4IIis1s1iiii", P3D.Identifiers.Old_Billboard_Quad_Group, Len, Len, Version, Name, Shader, ZTest, ZWrite, Fog, NumQuads)}
end

function P3D.OldBillboardQuadGroupP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + 4 + self.Name:len() + 1 + self.Shader:len() + 1 + 4 + 4 + 4 + 4
	return pack("<c4IIis1s1iiii", self.ChunkType, Len, Len + chunks:len(), self.Version, self.Name, self.Shader, self.ZTest, self.ZWrite, self.Fog, self.NumQuads) .. chunks
end

function P3D.OldBillboardQuadGroupP3DChunk:RemoveChunkAtIndex(idx)
	local ID = self.ChunkTypes[idx]
	P3D.OldBillboardQuadGroupP3DChunk.parentClass.RemoveChunkAtIndex(self, idx)
	if ID == P3D.Identifiers.Old_Billboard_Quad then
		self.NumQuads = self.NumQuads - 1
	end
end

--Old Billboard Quad Chunk
P3D.OldBillboardQuadP3DChunk = P3D.P3DChunk:newChildClass("Old Billboard Quad")
function P3D.OldBillboardQuadP3DChunk:new(Data)
	local o = P3D.OldBillboardQuadP3DChunk.parentClass.new(self, Data)
	o.Translate = {X=0,Y=0,Z=0}
	o.Colour = {A=0,R=0,G=0,B=0}
	o.UV1 = {X=0,Y=0}
	o.UV2 = {X=0,Y=0}
	o.UV3 = {X=0,Y=0}
	o.UV4 = {X=0,Y=0}
	o.UVOffset = {X=0,Y=0}
	o.Version, o.Name, o.BillboardMode, o.Translate.X, o.Translate.Y, o.Translate.Z, o.Colour.B, o.Colour.G, o.Colour.R, o.Colour.A, o.UV1.X, o.UV1.Y, o.UV2.X, o.UV2.Y, o.UV3.X, o.UV3.Y, o.UV4.X, o.UV4.Y, o.Width, o.Height, o.Distance, o.UVOffset.X, o.UVOffset.Y = unpack("<is1ifffBBBBfffffffffffff", o.ValueStr)
	return o
end

function P3D.OldBillboardQuadP3DChunk:create(Version,Name,BillboardMode,Translate,Colour,UV1,UV2,UV3,UV4,Width,Height,Distance,UVOffset)
	local Len = 12 + 4 + Name:len() + 1 + 4 + 12 + 4+ 8+ 8+ 8+ 8 + 4 + 4 + 4+ 8
	return P3D.OldBillboardQuadP3DChunk:new{Raw = pack("<c4IIis1ifffBBBBfffffffffffff", P3D.Identifiers.Old_Billboard_Quad, Len, Len, Version, Name, BillboardMode, Translate.X, Translate.Y, Translate.Z, Colour.B, Colour.G, Colour.R, Colour.A, UV1.X, UV1.Y, UV2.X, UV2.Y, UV3.X, UV3.Y, UV4.X, UV4.Y, Width, Height, Distance, UVOffset.X, UVOffset.Y)}
end

function P3D.OldBillboardQuadP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + 4 + self.Name:len() + 1 + 4 + 12 + 4+ 8+ 8+ 8+ 8 + 4 + 4 + 4+ 8
	return pack("<c4IIis1ifffBBBBfffffffffffff", self.ChunkType, Len, Len + chunks:len(), self.Version, self.Name, self.BillboardMode, self.Translate.X, self.Translate.Y, self.Translate.Z, self.Colour.B, self.Colour.G, self.Colour.R, self.Colour.A, self.UV1.X, self.UV1.Y, self.UV2.X, self.UV2.Y, self.UV3.X, self.UV3.Y, self.UV4.X, self.UV4.Y, self.Width, self.Height, self.Distance, self.UVOffset.X, self.UVOffset.Y) .. chunks
end

--Light Chunk
P3D.LightP3DChunk = P3D.P3DChunk:newChildClass("Light")
function P3D.LightP3DChunk:new(Data)
	local o = P3D.LightP3DChunk.parentClass.new(self, Data)
	o.Colour = {A=0,R=0,G=0,B=0}
	o.Name, o.Version, o.Type, o.Colour.B, o.Colour.G, o.Colour.R, o.Colour.A, o.Constant, o.Linear, o.Squared, o.Enabled = unpack("<s1iiBBBBfffi", o.ValueStr)
	return o
end

function P3D.LightP3DChunk:create(Name,Version,Type,Colour,Constant,Linear,Squared,Enabled)
	local Len = 12 + Name:len() + 1 + 4 + 4 + 4 + 4 + 4 + 4 + 4
	return P3D.LightP3DChunk:new{Raw = pack("<c4IIs1iiBBBBfffi", P3D.Identifiers.Light, Len, Len, Name, Version, Type, Colour.B, Colour.G, Colour.R, Colour.A, Constant, Linear, Squared, Enabled)}
end

function P3D.LightP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4 + 4 + 4 + 4 + 4 + 4 + 4
	return pack("<c4IIs1iiBBBBfffi", self.ChunkType, Len, Len + chunks:len(), self.Name, self.Version, self.Type, self.Colour.B, self.Colour.G, self.Colour.R, self.Colour.A, self.Constant, self.Linear, self.Squared, self.Enabled) .. chunks
end

--Skin Chunk
P3D.SkinP3DChunk = P3D.P3DChunk:newChildClass("Skin")
function P3D.SkinP3DChunk:new(Data)
	local o = P3D.SkinP3DChunk.parentClass.new(self, Data)
	o.Name, o.Version, o.SkeletonName, o.NumPrimitiveGroups = unpack("<s1is1i", o.ValueStr)
	return o
end

function P3D.SkinP3DChunk:create(Name,Version,SkeletonName,NumPrimitiveGroups)
	local Len = 12 + Name:len() + 1 + 4 + SkeletonName:len() + 1 + 4
	return P3D.SkinP3DChunk:new{Raw = pack("<c4IIs1is1i", P3D.Identifiers.Skin, Len, Len, Name, Version, SkeletonName, NumPrimitiveGroups)}
end

function P3D.SkinP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + Name:len() + 1 + 4 + SkeletonName:len() + 1 + 4
	return pack("<c4IIs1is1i", self.ChunkType, Len, Len + chunks:len(), self.Name, self.Version, self.SkeletonName, self.NumPrimitiveGroups) .. chunks
end

function P3D.SkinP3DChunk:RemoveChunkAtIndex(idx)
	local ID = self.ChunkTypes[idx]
	P3D.SkinP3DChunk.parentClass.RemoveChunkAtIndex(self, idx)
	if ID == P3D.Identifiers.Old_Primitive_Group then
		self.NumPrimitiveGroups = self.NumPrimitiveGroups - 1
	end
end

--Composite Drawable Chunk
P3D.CompositeDrawableP3DChunk = P3D.P3DChunk:newChildClass("Composite Drawable")
function P3D.CompositeDrawableP3DChunk:new(Data)
	local o = P3D.CompositeDrawableP3DChunk.parentClass.new(self, Data)
	o.Name, o.SkeletonName = unpack("<s1s1", o.ValueStr)
	return o
end

function P3D.CompositeDrawableP3DChunk:create(Name,SkeletonName)
	local Len = 12 + Name:len() + 1 + SkeletonName:len() + 1
	return P3D.CompositeDrawableP3DChunk:new{Raw = pack("<c4IIs1s1", P3D.Identifiers.Composite_Drawable, Len, Len, Name, SkeletonName)}
end

function P3D.CompositeDrawableP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + self.SkeletonName:len() + 1
	return pack("<c4IIs1s1", self.ChunkType, Len, Len + chunks:len(), self.Name, self.SkeletonName) .. chunks
end

--Composite Drawable Skin List Chunk
P3D.CompositeDrawableSkinListP3DChunk = P3D.P3DChunk:newChildClass("Composite Drawable Skin List")
function P3D.CompositeDrawableSkinListP3DChunk:new(Data)
	local o = P3D.CompositeDrawableSkinListP3DChunk.parentClass.new(self, Data)
	o.NumElements = unpack("<i", o.ValueStr)
	return o
end

function P3D.CompositeDrawableSkinListP3DChunk:create(NumElements)
	local Len = 12 + 4
	return P3D.CompositeDrawableSkinListP3DChunk:new{Raw = pack("<c4IIi", P3D.Identifiers.Composite_Drawable_Skin_List, Len, Len, NumElements)}
end

function P3D.CompositeDrawableSkinListP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + 4
	return pack("<c4IIi", self.ChunkType, Len, Len + chunks:len(), #self.Chunks) .. chunks
end

--Composite Drawable Skin Chunk
P3D.CompositeDrawableSkinP3DChunk = P3D.P3DChunk:newChildClass("Composite Drawable Skin")
function P3D.CompositeDrawableSkinP3DChunk:new(Data)
	local o = P3D.CompositeDrawableSkinP3DChunk.parentClass.new(self, Data)
	o.Name, o.IsTranslucent = unpack("<s1i", o.ValueStr)
	return o
end

function P3D.CompositeDrawableSkinP3DChunk:create(Name,IsTranslucent)
	local Len = 12 + Name:len() + 1 + 4
	return P3D.CompositeDrawableSkinP3DChunk:new{Raw = pack("<c4IIs1i", P3D.Identifiers.Composite_Drawable_Skin, Len, Len, Name, IsTranslucent)}
end

function P3D.CompositeDrawableSkinP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4
	return pack("<c4IIs1i", self.ChunkType, Len, Len + chunks:len(), self.Name, self.IsTranslucent) .. chunks
end

--Composite Drawable Prop List Chunk
P3D.CompositeDrawablePropListP3DChunk = P3D.P3DChunk:newChildClass("Composite Drawable Prop List")
function P3D.CompositeDrawablePropListP3DChunk:new(Data)
	local o = P3D.CompositeDrawablePropListP3DChunk.parentClass.new(self, Data)
	o.NumElements = unpack("<i", o.ValueStr)
	return o
end

function P3D.CompositeDrawablePropListP3DChunk:create(NumElements)
	local Len = 12 + 4
	return P3D.CompositeDrawablePropListP3DChunk:new{Raw = pack("<c4IIi", P3D.Identifiers.Composite_Drawable_Prop_List, Len, Len, NumElements)}
end

function P3D.CompositeDrawablePropListP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + 4
	return pack("<c4IIi", self.ChunkType, Len, Len + chunks:len(), #self.Chunks) .. chunks
end

--Composite Drawable Prop Chunk
P3D.CompositeDrawablePropP3DChunk = P3D.P3DChunk:newChildClass("Composite Drawable Prop")
function P3D.CompositeDrawablePropP3DChunk:new(Data)
	local o = P3D.CompositeDrawablePropP3DChunk.parentClass.new(self, Data)
	o.Name, o.IsTranslucent, o.SkeletonJointID = unpack("<s1ii", o.ValueStr)
	return o
end

function P3D.CompositeDrawablePropP3DChunk:create(Name,IsTranslucent,SkeletonJointID)
	local Len = 12 + Name:len() + 1 + 4 + 4
	return P3D.CompositeDrawablePropP3DChunk:new{Raw = pack("<c4IIs1ii", P3D.Identifiers.Composite_Drawable_Prop, Len, Len, Name, IsTranslucent, SkeletonJointID)}
end

function P3D.CompositeDrawablePropP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4 + 4
	return pack("<c4IIs1ii", self.ChunkType, Len, Len + chunks:len(), self.Name, self.IsTranslucent, self.SkeletonJointID) .. chunks
end

--Composite Drawable Effect List Chunk
P3D.CompositeDrawableEffectListP3DChunk = P3D.P3DChunk:newChildClass("Composite Drawable Effect List")
function P3D.CompositeDrawableEffectListP3DChunk:new(Data)
	local o = P3D.CompositeDrawableEffectListP3DChunk.parentClass.new(self, Data)
	o.NumElements = unpack("<i", o.ValueStr)
	return o
end

function P3D.CompositeDrawableEffectListP3DChunk:create(NumElements)
	local Len = 12 + 4
	return P3D.CompositeDrawableEffectListP3DChunk:new{Raw = pack("<c4IIi", P3D.Identifiers.Composite_Drawable_Effect_List, Len, Len, NumElements)}
end

function P3D.CompositeDrawableEffectListP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + 4
	return pack("<c4IIi", self.ChunkType, Len, Len + chunks:len(), #self.Chunks) .. chunks
end

--Composite Drawable Effect Chunk
P3D.CompositeDrawableEffectP3DChunk = P3D.P3DChunk:newChildClass("Composite Drawable Effect")
function P3D.CompositeDrawableEffectP3DChunk:new(Data)
	local o = P3D.CompositeDrawableEffectP3DChunk.parentClass.new(self, Data)
	o.Name, o.IsTranslucent, o.SkeletonJointID = unpack("<s1ii", o.ValueStr)
	return o
end

function P3D.CompositeDrawableEffectP3DChunk:create(Name,IsTranslucent,SkeletonJointID)
	local Len = 12 + Name:len() + 1 + 4 + 4
	return P3D.CompositeDrawableEffectP3DChunk:new{Raw = pack("<c4IIs1ii", P3D.Identifiers.Composite_Drawable_Effect, Len, Len, Name, IsTranslucent, SkeletonJointID)}
end

function P3D.CompositeDrawableEffectP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4 + 4
	return pack("<c4IIs1ii", self.ChunkType, Len, Len + chunks:len(), self.Name, self.IsTranslucent, self.SkeletonJointID) .. chunks
end

--Collision Effect Chunk
P3D.CollisionEffectP3DChunk = P3D.P3DChunk:newChildClass("Collision Effect")
function P3D.CollisionEffectP3DChunk:new(Data)
	local o = P3D.CollisionEffectP3DChunk.parentClass.new(self, Data)
	o.Classtype, o.ATCEntry, o.SoundResourceDataName = unpack("<iis1", o.ValueStr)
	return o
end

function P3D.CollisionEffectP3DChunk:create(Classtype,ATCEntry,SoundResourceDataName)
	local Len = 12 + 4 + 4 + SoundResourceDataName:len() + 1
	return P3D.CollisionEffectP3DChunk:new{Raw = pack("<c4IIiis1", P3D.Identifiers.Collision_Effect, Len, Len, Classtype, ATCEntry, SoundResourceDataName)}
end

function P3D.CollisionEffectP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + 4 + 4 + self.SoundResourceDataName:len() + 1
	return pack("<c4IIiis1", self.ChunkType, Len, Len + chunks:len(), self.Classtype, self.ATCEntry, self.SoundResourceDataName) .. chunks
end

--State Prop Data V1 Chunk
P3D.StatePropDataV1P3DChunk = P3D.P3DChunk:newChildClass("State Prop Data V1")
function P3D.StatePropDataV1P3DChunk:new(Data)
	local o = P3D.StatePropDataV1P3DChunk.parentClass.new(self, Data)
	o.Version, o.Name, o.ObjectFactoryName, o.NumStates = unpack("<is1s1i", o.ValueStr)
	return o
end

function P3D.StatePropDataV1P3DChunk:create(Version,Name,ObjectFactoryName,NumStates)
	local Len = 12 + 4 + Name:len() + 1 + ObjectFactoryName:len() + 1 + 4
	return P3D.StatePropDataV1P3DChunk:new{Raw = pack("<c4IIis1s1i", P3D.Identifiers.State_Prop_Data_V1, Len, Len, Version, Name, ObjectFactoryName, NumStates)}
end

function P3D.StatePropDataV1P3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + 4 + self.Name:len() + 1 + self.ObjectFactoryName:len() + 1 + 4
	return pack("<c4IIis1s1i", self.ChunkType, Len, Len + chunks:len(), self.Version, self.Name, self.ObjectFactoryName, self.NumStates) .. chunks
end

function P3D.StatePropDataV1P3DChunk:RemoveChunkAtIndex(idx)
	local ID = self.ChunkTypes[idx]
	P3D.StatePropDataV1P3DChunk.parentClass.RemoveChunkAtIndex(self, idx)
	if ID == P3D.Identifiers.State_Prop_State_Data_V1 then
		self.NumStates = self.NumStates - 1
	end
end

--State Prop State Data V1 Chunk
P3D.StatePropStateDataV1P3DChunk = P3D.P3DChunk:newChildClass("State Prop State Data V1")
function P3D.StatePropStateDataV1P3DChunk:new(Data)
	local o = P3D.StatePropStateDataV1P3DChunk.parentClass.new(self, Data)
	o.Name, o.AutoTransition, o.OutState, o.NumDrawables, o.NumFrameControllers, o.NumEvents, o.NumCallbacks, o.OutFrame = unpack("<s1iiiiiif", o.ValueStr)
	return o
end

function P3D.StatePropStateDataV1P3DChunk:create(Name,AutoTransition,OutState,NumDrawables,NumFrameControllers,NumEvents,NumCallbacks,OutFrame)
	local Len = 12 + Name:len() + 1 + 4 + 4 + 4 + 4 + 4 + 4 + 4
	return P3D.StatePropStateDataV1P3DChunk:new{Raw = pack("<c4IIs1iiiiiif", P3D.Identifiers.State_Prop_State_Data_V1, Len, Len, Name, AutoTransition, OutState, NumDrawables, NumFrameControllers, NumEvents, NumCallbacks, OutFrame)}
end

function P3D.StatePropStateDataV1P3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4 + 4 + 4 + 4 + 4 + 4 + 4
	return pack("<c4IIs1iiiiiif", self.ChunkType, Len, Len + chunks:len(), self.Name, self.AutoTransition, self.OutState, self.NumDrawables, self.NumFrameControllers, self.NumEvents, self.NumCallbacks, self.OutFrame) .. chunks
end

function P3D.StatePropStateDataV1P3DChunk:RemoveChunkAtIndex(idx)
	local ID = self.ChunkTypes[idx]
	P3D.StatePropStateDataV1P3DChunk.parentClass.RemoveChunkAtIndex(self, idx)
	if ID == P3D.Identifiers.State_Prop_Event_Data then
		self.NumEvents = self.NumEvents - 1
	elseif ID == P3D.Identifiers.State_Prop_Visibilities_Data then
		self.NumDrawables = self.NumDrawables - 1
	elseif ID == P3D.Identifiers.State_Prop_Frame_Controller_Data then
		self.NumFrameControllers = self.NumFrameControllers - 1
	elseif ID == P3D.Identifiers.State_Prop_Callback_Data then
		self.NumCallbacks = self.NumCallbacks - 1
	end
end

--Locator Chunk TODO: Handle types
P3D.LocatorP3DChunk = P3D.P3DChunk:newChildClass("Locator")
function P3D.LocatorP3DChunk:new(Data)
	local o = P3D.LocatorP3DChunk.parentClass.new(self, Data)
	o.Name, o.Type, o.DataLen = unpack("<s1ii", o.ValueStr)
	local idx = o.Name:len() + 1 + 4 + 4 + 1
	o.Position = {X=0,Y=0,Z=0}
	o.Data, o.Position.X, o.Position.Y, o.Position.Z, o.NumTriggers = unpack("<c" .. o.DataLen * 4 .. "fffi", o.ValueStr, idx)
	return o
end

--function P3D.LocatorP3DChunk:create()
	--TODO: Locators are awful
--	return nil
--end

function P3D.LocatorP3DChunk:GetType9Data()
	local data, Unknown1, Unknown2 = unpack("<c" .. (self.DataLen - 2) * 4 .. "ii", self.ValueStr, self.Name:len() + 1 + 4 + 4 + 1)
	local UnknownStr1, UnknownStr2, Type
	local index = 1
	local position = 1
	local buffer = {}
	for i=1,#data do
		if data:byte(i) ~= 0 then
			buffer[#buffer + 1] = data:sub(i, i)
		else
			if #buffer > 0 then
				if index == 1 then
					UnknownStr1 = table.concat(buffer)
				elseif index == 2 then
					UnknownStr2 = table.concat(buffer)
				elseif index == 3 then
					Type = table.concat(buffer)
				end
				buffer = {}
				index = index + 1
			end
		end
	end
	return Type, UnknownStr1, UnknownStr2, Unknown1, Unknown2
end

function P3D.LocatorP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4 + 4 + self.Data:len() + 12
	return pack("<c4IIs1iic" .. self.DataLen .."fffi", self.ChunkType, Len, Len + chunks:len(), self.Name, self.Type, self.DataLen, self.Data, self.Position.X, self.Position.Y, self.Position.Z, self.NumTriggers) .. chunks
end

--Skeleton Chunk
P3D.SkeletonP3DChunk = P3D.P3DChunk:newChildClass("Skeleton")
function P3D.SkeletonP3DChunk:new(Data)
	local o = P3D.SkeletonP3DChunk.parentClass.new(self, Data)
	o.Name, o.Version, o.NumJoints = unpack("<s1ii", o.ValueStr)
	return o
end

function P3D.SkeletonP3DChunk:create(Name,Version,NumJoints)
	local Len = 12 + Name:len() + 1 + 4 + 4
	return P3D.SkeletonP3DChunk:new{Raw = pack("<c4IIs1ii", P3D.Identifiers.Skeleton, Len, Len, Name, Version, NumJoints)}
end

function P3D.SkeletonP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4 + 4
	return pack("<c4IIs1ii", self.ChunkType, Len, Len + chunks:len(), self.Name, self.Version, self.NumJoints) .. chunks
end

function P3D.SkeletonP3DChunk:RemoveChunkAtIndex(idx)
	local ID = self.ChunkTypes[idx]
	P3D.SkeletonP3DChunk.parentClass.RemoveChunkAtIndex(self, idx)
	if ID == P3D.Identifiers.Skeleton_Joint then
		self.NumJoints = self.NumJoints - 1
	end
end

--Skeleton Joint Chunk
P3D.SkeletonJointP3DChunk = P3D.P3DChunk:newChildClass("Skeleton Joint")
function P3D.SkeletonJointP3DChunk:new(Data)
	local o = P3D.SkeletonJointP3DChunk.parentClass.new(self, Data)
	o.RestPose = P3D.MatrixIdentity()
	o.Name, o.Parent, o.DOF, o.FreeAxis, o.PrimaryAxis, o.SecondaryAxis, o.TwistAxis, o.RestPose.M11, o.RestPose.M12, o.RestPose.M13, o.RestPose.M14, o.RestPose.M21, o.RestPose.M22, o.RestPose.M23, o.RestPose.M34, o.RestPose.M31, o.RestPose.M32, o.RestPose.M33, o.RestPose.M34, o.RestPose.M41, o.RestPose.M42, o.RestPose.M43, o.RestPose.M44 = unpack("<s1iiiiiiffffffffffffffff", o.ValueStr)
	return o
end

function P3D.SkeletonJointP3DChunk:create(Name,Parent,DOF,FreeAxis,PrimaryAxis,SecondaryAxis,TwistAxis,RestPose)
	local Len = 12 + Name:len() + 1 + 4 + 4 + 4 + 4 + 4 + 4 + 64
	return P3D.SkeletonJointP3DChunk:new{Raw = pack("<c4IIs1iiiiiiffffffffffffffff", P3D.Identifiers.Skeleton_Joint, Len, Len, Name, Parent, DOF, FreeAxis, PrimaryAxis, SecondaryAxis, TwistAxis, RestPose.M11, RestPose.M12, RestPose.M13, RestPose.M14, RestPose.M21, RestPose.M22, RestPose.M23, RestPose.M34, RestPose.M31, RestPose.M32, RestPose.M33, RestPose.M34, RestPose.M41, RestPose.M42, RestPose.M43, RestPose.M44)}
end

function P3D.SkeletonJointP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4 + 4 + 4 + 4 + 4 + 4 + 64
	return pack("<c4IIs1iiiiiiffffffffffffffff", self.ChunkType, Len, Len + chunks:len(), self.Name, self.Parent, self.DOF, self.FreeAxis, self.PrimaryAxis, self.SecondaryAxis, self.TwistAxis, self.RestPose.M11, self.RestPose.M12, self.RestPose.M13, self.RestPose.M14, self.RestPose.M21, self.RestPose.M22, self.RestPose.M23, self.RestPose.M34, self.RestPose.M31, self.RestPose.M32, self.RestPose.M33, self.RestPose.M34, self.RestPose.M41, self.RestPose.M42, self.RestPose.M43, self.RestPose.M44) .. chunks
end

--Old Frame Controller Chunk
P3D.OldFrameControllerP3DChunk = P3D.P3DChunk:newChildClass("Old Frame Controller")
function P3D.OldFrameControllerP3DChunk:new(Data)
	local o = P3D.OldFrameControllerP3DChunk.parentClass.new(self, Data)
	o.Version, o.Name, o.Type, o.FrameOffset, o.HierarchyName, o.AnimationName = unpack("<is1c4fs1s1", o.ValueStr)
	return o
end

function P3D.OldFrameControllerP3DChunk:create(Version,Name,Type,FrameOffset,HierarchyName,AnimationName)
	local Len = 12 + 4 + Name:len() + 1 + 4 + 4 + HierarchyName:len() + 1 + AnimationName:len() + 1
	return P3D.OldFrameControllerP3DChunk:new{Raw = pack("<c4IIis1c4fs1s1", P3D.Identifiers.Old_Frame_Controller, Len, Len, Version, Name, Type, FrameOffset, HierarchyName, AnimationName)}
end

function P3D.OldFrameControllerP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + 4 + self.Name:len() + 1 + 4 + 4 + self.HierarchyName:len() + 1 + self.AnimationName:len() + 1
	return pack("<c4IIis1c4fs1s1", self.ChunkType, Len, Len + chunks:len(), self.Version, self.Name, self.Type, self.FrameOffset, self.HierarchyName, self.AnimationName) .. chunks
end

--Collision Object Chunk
P3D.CollisionObjectP3DChunk = P3D.P3DChunk:newChildClass("Collision Object")
function P3D.CollisionObjectP3DChunk:new(Data)
	local o = P3D.CollisionObjectP3DChunk.parentClass.new(self, Data)
	o.Name, o.Version, o.MaterialName, o.NumSubObject, o.NumOwner = unpack("<s1is1ii", o.ValueStr)
	return o
end

function P3D.CollisionObjectP3DChunk:create(Name,Version,MaterialName,NumSubObject,NumOwner)
	local Len = 12 + Name:len() + 1 + 4 + MaterialName:len() + 1 + 4 + 4
	return P3D.CollisionObjectP3DChunk:new{Raw = pack("<c4IIs1is1ii", P3D.Identifiers.Collision_Object, Len, Len, Name, Version, MaterialName, NumSubObject, NumOwner)}
end

function P3D.CollisionObjectP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4 + self.MaterialName:len() + 1 + 4 + 4
	return pack("<c4IIs1is1ii", self.ChunkType, Len, Len + chunks:len(), self.Name, self.Version, self.MaterialName, self.NumSubObject, self.NumOwner) .. chunks
end

--Multi Controller Chunk
P3D.MultiControllerP3DChunk = P3D.P3DChunk:newChildClass("Multi Controller")
function P3D.MultiControllerP3DChunk:new(Data)
	local o = P3D.MultiControllerP3DChunk.parentClass.new(self, Data)
	o.Name, o.Version, o.Length, o.Framerate, o.NumTracks = unpack("<s1iffi", o.ValueStr)
	return o
end

function P3D.MultiControllerP3DChunk:create(Name,Version,Length,Framerate,NumTracks)
	local Len = 12 + Name:len() + 1 + 4 + 4 + 4 + 4
	return P3D.MultiControllerP3DChunk:new{Raw = pack("<c4IIs1iffi", P3D.Identifiers.Multi_Controller, Len, Len, Name, Version, Length, Framerate, NumTracks)}
end

function P3D.MultiControllerP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4 + 4 + 4 + 4
	return pack("<c4IIs1iffi", self.ChunkType, Len, Len + chunks:len(), self.Name, self.Version, self.Length, self.Framerate, self.NumTracks) .. chunks
end

--Multi Controller Tracks chunk
P3D.MultiControllerTracksP3DChunk = P3D.P3DChunk:newChildClass("Multi Controller Tracks")
function P3D.MultiControllerTracksP3DChunk:new(Data)
	local o = P3D.MultiControllerTracksP3DChunk.parentClass.new(self, Data)
	local NumTracks = unpack("<i", o.ValueStr)
	o.Tracks = {}
	local idx = 5
	for i=0,NumTracks - 1 do
		local track = {Name="",StartTime=0,EndTime=0,Scale=0}
		track.Name, track.StartTime, track.EndTime, track.Scale = unpack("<s1fff", o.ValueStr, idx)
		idx = idx + track.Name:len() + 1 + 4 + 4 + 4
		o.Tracks[#o.Tracks + 1] = track
	end
	return o
end

function P3D.MultiControllerTracksP3DChunk:create(...)
	local TracksN = #arg
	local len = 16
	local tracks = {}
	for i=1,TracksN do
		local track = arg[i]
		tracks[#tracks + 1] = pack("<s1fff", track.Name, track.StartTime, track.EndTime, track.Scale)
		len = len + track.Name:len() + 1 + 4 + 4 + 4
	end
	return P3D.MeshP3DChunk:new{Raw = pack("<c4IIi", P3D.Identifiers.Multi_Controller_Tracks, len, len, TracksN) .. table.concat(tracks)}
end

function P3D.MultiControllerTracksP3DChunk:Output()
	local TracksN = #self.Tracks
	local len = 16
	local tracks = {}
	for i=1,TracksN do
		local track = self.Tracks[i]
		tracks[#tracks + 1] = pack("<s1fff", track.Name, track.StartTime, track.EndTime, track.Scale)
		len = len + track.Name:len() + 1 + 4 + 4 + 4
	end
	return pack("<c4IIi", P3D.Identifiers.Multi_Controller_Tracks, len, len, TracksN) .. table.concat(tracks)
end

--Animation Chunk
P3D.AnimationP3DChunk = P3D.P3DChunk:newChildClass("Animation")
function P3D.AnimationP3DChunk:new(Data)
	local o = P3D.AnimationP3DChunk.parentClass.new(self, Data)
	o.Version, o.Name, o.AnimationType, o.NumFrames, o.FrameRate, o.Cyclic = unpack("<is1c4ffi", o.ValueStr)
	return o
end

function P3D.AnimationP3DChunk:create(Version,Name,AnimationType,NumFrames,FrameRate,Cyclic)
	local Len = 12 + 4 + Name:len() + 1 + AnimationType:len() + 4 + 4 + 4
	return P3D.AnimationP3DChunk:new{Raw = pack("<c4IIis1c4ffi", P3D.Identifiers.Animation, Len, Len, Version, Name, AnimationType, NumFrames, FrameRate, Cyclic)}
end

function P3D.AnimationP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + 4 + self.Name:len() + 1 + self.AnimationType:len() + 4 + 4 + 4
	return pack("<c4IIis1c4ffi", self.ChunkType, Len, Len + chunks:len(), self.Version, self.Name, self.AnimationType, self.NumFrames, self.FrameRate, self.Cyclic) .. chunks
end

--Particle System 2 Chunk
P3D.ParticleSystem2P3DChunk = P3D.P3DChunk:newChildClass("Particle System 2")
function P3D.ParticleSystem2P3DChunk:new(Data)
	local o = P3D.ParticleSystem2P3DChunk.parentClass.new(self, Data)
	o.Version, o.Name, o.Unknown = unpack("<is1s1", o.ValueStr)
	return o
end

function P3D.ParticleSystem2P3DChunk:create(Version,Name,Unknown)
	local Len = 12 + 4 + Name:len() + 1 + Unknown:len() + 1
	return P3D.ParticleSystem2P3DChunk:new{Raw = pack("<c4IIis1s1", P3D.Identifiers.Particle_System_2, Len, Len, Version, Name, Unknown)}
end

function P3D.ParticleSystem2P3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + 4 + self.Name:len() + 1 + self.Unknown:len() + 1
	return pack("<c4IIis1s1", self.ChunkType, Len, Len + chunks:len(), self.Version, self.Name, self.Unknown) .. chunks
end

--Particle System Factory Chunk
P3D.ParticleSystemFactoryP3DChunk = P3D.P3DChunk:newChildClass("Particle System Factory")
function P3D.ParticleSystemFactoryP3DChunk:new(Data)
	local o = P3D.ParticleSystemFactoryP3DChunk.parentClass.new(self, Data)
	o.Version, o.Name, o.FrameRate, o.NumAnimFrames, o.NumOLFrames, o.CycleAnim, o.EnableSorting, o.NumEmitters = unpack("<is1fiihhi", o.ValueStr)
	return o
end

function P3D.ParticleSystemFactoryP3DChunk:create(Version,Name,FrameRate,NumAnimFrames,NumOLFrames,CycleAnim,EnableSorting,NumEmitters)
	local Len = 12 + 4 + Name:len() + 1 + 4 + 4 + 4 + 2 + 2 + 4
	return P3D.ParticleSystemFactoryP3DChunk:new{Raw = pack("<c4IIis1fiihhi", P3D.Identifiers.Particle_System_Factory, Len, Len, Version, Name, FrameRate, NumAnimFrames, NumOLFrames, CycleAnim, EnableSorting, NumEmitters)}
end

function P3D.ParticleSystemFactoryP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + 4 + self.Name:len() + 1 + 4 + 4 + 4 + 2 + 2 + 4
	return pack("<c4IIis1fiihhi", self.ChunkType, Len, Len + chunks:len(), self.Version, self.Name, self.FrameRate, self.NumAnimFrames, self.NumOLFrames, self.CycleAnim, self.EnableSorting, self.NumEmitters) .. chunks
end

--Instance List Chunk
P3D.InstanceListP3DChunk = P3D.P3DChunk:newChildClass("Instance List")
function P3D.InstanceListP3DChunk:new(Data)
	local o = P3D.InstanceListP3DChunk.parentClass.new(self, Data)
	o.Name = unpack("<s1", o.ValueStr)
	o.Data = o.ValueStr:sub(o.Name:len() + 1)
	return o
end

function P3D.InstanceListP3DChunk:create(Name,Data)
	local Len = 12 + Name:len() + 1 + Data:len()
	return P3D.InstanceListP3DChunk:new{Raw = pack("<c4IIs1i", P3D.Identifiers.Instance_List, Len, Len, Name) .. Data}
end

function P3D.InstanceListP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + self.Data:len()
	return pack("<c4IIs1", self.ChunkType, Len, Len + chunks:len(), self.Name) .. self.Data .. chunks
end

--Scenegraph Chunk
P3D.ScenegraphP3DChunk = P3D.P3DChunk:newChildClass("Scenegraph")
function P3D.ScenegraphP3DChunk:new(Data)
	local o = P3D.ScenegraphP3DChunk.parentClass.new(self, Data)
	o.Name = unpack("<s1", o.ValueStr)
	o.Data = o.ValueStr:sub(o.Name:len() + 1)
	return o
end

function P3D.ScenegraphP3DChunk:create(Name,Data)
	local Len = 12 + Name:len() + 1 + Data:len()
	return P3D.ScenegraphP3DChunk:new{Raw = pack("<c4IIs1", P3D.Identifiers.Scenegraph, Len, Len, Name) .. Data}
end

function P3D.ScenegraphP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + self.Data:len()
	return pack("<c4IIs1", self.ChunkType, Len, Len + chunks:len(), self.Name) .. self.Data .. chunks
end

--Old Scenegraph Root Chunk
P3D.OldScenegraphRootP3DChunk = P3D.P3DChunk:newChildClass("Old Scenegraph Root")
function P3D.OldScenegraphRootP3DChunk:new(Data)
	local o = P3D.OldScenegraphRootP3DChunk.parentClass.new(self, Data)
	return o
end

--Old Scenegraph Branch Chunk
P3D.OldScenegraphBranchP3DChunk = P3D.P3DChunk:newChildClass("Old Scenegraph Branch")
function P3D.OldScenegraphBranchP3DChunk:new(Data)
	local o = P3D.OldScenegraphBranchP3DChunk.parentClass.new(self, Data)
	o.Name, o.NumChildren = unpack("<s1i", o.ValueStr)
	return o
end

function P3D.OldScenegraphBranchP3DChunk:create(Name,NumChildren)
	local Len = 12 + Name:len() + 1 + 4
	return P3D.OldScenegraphBranchP3DChunk:new{Raw = pack("<c4IIs1i", P3D.Identifiers.Old_Scenegraph_Branch, Len, Len, Name, NumChildren)}
end

function P3D.OldScenegraphBranchP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4
	return pack("<c4IIs1i", self.ChunkType, Len, Len + chunks:len(), self.Name, #self.Chunks) .. chunks
end

--Old Scenegraph Transform Chunk
P3D.OldScenegraphTransformP3DChunk = P3D.P3DChunk:newChildClass("Old Scenegraph Transform")
function P3D.OldScenegraphTransformP3DChunk:new(Data)
	local o = P3D.OldScenegraphTransformP3DChunk.parentClass.new(self, Data)
	o.Transform = P3D.MatrixIdentity()
	o.Name, o.NumChildren, o.Transform.M11, o.Transform.M12, o.Transform.M13, o.Transform.M14, o.Transform.M21, o.Transform.M22, o.Transform.M23, o.Transform.M34, o.Transform.M31, o.Transform.M32, o.Transform.M33, o.Transform.M34, o.Transform.M41, o.Transform.M42, o.Transform.M43, o.Transform.M44 = unpack("<s1iffffffffffffffff", o.ValueStr)
	return o
end

function P3D.OldScenegraphTransformP3DChunk:create(Name,NumChildren,Transform)
	local Len = 12 + Name:len() + 1 + 4 + 64
	return P3D.OldScenegraphTransformP3DChunk:new{Raw = pack("<c4IIs1iffffffffffffffff", P3D.Identifiers.Old_Scenegraph_Transform, Len, Len, Name, NumChildren, Transform.M11, Transform.M12, Transform.M13, Transform.M14, Transform.M21, Transform.M22, Transform.M23, Transform.M34, Transform.M31, Transform.M32, Transform.M33, Transform.M34, Transform.M41, Transform.M42, Transform.M43, Transform.M44)}
end

function P3D.OldScenegraphTransformP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + 4 + 64
	return pack("<c4IIs1iffffffffffffffff", self.ChunkType, Len, Len + chunks:len(), self.Name, #self.Chunks, self.Transform.M11, self.Transform.M12, self.Transform.M13, self.Transform.M14, self.Transform.M21, self.Transform.M22, self.Transform.M23, self.Transform.M34, self.Transform.M31, self.Transform.M32, self.Transform.M33, self.Transform.M34, self.Transform.M41, self.Transform.M42, self.Transform.M43, self.Transform.M44) .. chunks
end

--Old Scenegraph Drawable Chunk
P3D.OldScenegraphDrawableP3DChunk = P3D.P3DChunk:newChildClass("Old Scenegraph Drawable")
function P3D.OldScenegraphDrawableP3DChunk:new(Data)
	local o = P3D.OldScenegraphDrawableP3DChunk.parentClass.new(self, Data)
	o.Name, o.DrawableName, o.IsTranslucent = unpack("<s1s1i", o.ValueStr)
	return o
end

function P3D.OldScenegraphDrawableP3DChunk:create(Name,DrawableName,IsTranslucent)
	local Len = 12 + Name:len() + 1 + DrawableName:len() + 1 + 4
	return P3D.OldScenegraphDrawableP3DChunk:new{Raw = pack("<c4IIs1s1i", P3D.Identifiers.Old_Scenegraph_Drawable, Len, Len, Name, DrawableName, IsTranslucent)}
end

function P3D.OldScenegraphDrawableP3DChunk:Output()
	local chunks = table.concat(self.Chunks)
	local Len = 12 + self.Name:len() + 1 + self.DrawableName:len() + 1 + 4
	return pack("<c4IIs1s1i", self.ChunkType, Len, Len + chunks:len(), self.Name, self.DrawableName, self.IsTranslucent) .. chunks
end